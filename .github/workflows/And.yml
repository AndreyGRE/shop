# name: ðŸš€ Deploy Next.js via SSH

# on:
#   push:
#     branches: [ master, main ] 
# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: ðŸ§¾ Checkout repository 
#       uses: actions/checkout@v4

#     - name: ðŸš€ Deploy to server via SSH
#       uses: appleboy/ssh-action@v1.0.3
#       with:
#         host: ${{ secrets.SSH_HOST }}
#         username: ${{ secrets.SSH_USERNAME }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           echo "ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
#           cd /var/www/html/shop

#           echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´..."
#           git fetch origin master
#           git reset --hard origin/master 

#           echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸....!"
#           npm install

#           echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
#           npm run build

#           echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PM2..."
#           # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· npm start
#           pkill -f "npm start" || true
          
#           # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· PM2
#           pm2 delete next-app || true
#           pm2 start npm --name "next-app" -- start
#           pm2 save
#           pm2 startup

#           echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!!"
#           echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
#           pm2 status
name: ðŸš€ Deploy Next.js via SSH

on:
  push:
    branches: [ master, main ] 
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ§¾ Checkout repository 
      uses: actions/checkout@v4

    - name: ðŸš€ Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # script: |
        #   echo "ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
        #   cd /var/www/html/shop

        #   echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´..."
        #   git fetch origin master
        #   git reset --hard origin/master 

        #   echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ node_modules Ð¸ ÐºÑÑˆ..."
        #   rm -rf node_modules
        #   rm -rf .next
        #   npm cache clean --force

        #   echo "ðŸ“¦ ÐŸÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
        #   npm install

        #   echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
        #   npx next build

        #   echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PM2..."
        #   pm2 delete next-app 2>/dev/null || true
        #   pm2 start npm --name "next-app" -- start
        #   pm2 save 2>/dev/null

        #   echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
        #   pm2 status
        script: |
          echo "ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
          cd /var/www/html/shop

          # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Git Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð² ÑÑ‚Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          git config --global --add safe.directory /var/www/html/shop

          echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´..."
          git fetch origin master
          git reset --hard origin/master

          echo "ðŸ§¹ ÐŸÐžÐ›ÐÐÐ¯ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°..."
          rm -rf node_modules
          rm -rf .next
          rm -f package-lock.json
          npm cache clean --force

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
          sudo chown -R www-data:www-data /var/www/html/shop

          echo "ðŸ“¦ Ð§Ð¸ÑÑ‚Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ npm Ð¾Ñ‚ www-data
          sudo -u www-data npm install --legacy-peer-deps

          echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
          sudo -u www-data npx next build

          echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PM2..."
          sudo -u www-data pm2 delete next-app 2>/dev/null || true
          sudo -u www-data pm2 start npm --name "next-app" -- start --cwd /var/www/html/shop
          sudo -u www-data pm2 save 2>/dev/null

          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          sudo -u www-data pm2 status