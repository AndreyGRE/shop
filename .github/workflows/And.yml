# name: üöÄ Deploy Next.js via SSH

# on:
#   push:
#     branches: [ master, main ] 
# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: üßæ Checkout repository 
#       uses: actions/checkout@v4

#     - name: üöÄ Deploy to server via SSH
#       uses: appleboy/ssh-action@v1.0.3
#       with:
#         host: ${{ secrets.SSH_HOST }}
#         username: ${{ secrets.SSH_USERNAME }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
#           cd /var/www/html/shop

#           echo "üì• –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
#           git fetch origin master
#           git reset --hard origin/master 

#           echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏....!"
#           npm install

#           echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
#           npm run build

#           echo "‚ö° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PM2..."
#           # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ npm start
#           pkill -f "npm start" || true
          
#           # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
#           pm2 delete next-app || true
#           pm2 start npm --name "next-app" -- start
#           pm2 save
#           pm2 startup

#           echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!!"
#           echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
#           pm2 status
name: üöÄ Deploy Next.js via SSH

on:
  push:
    branches: [ master, main ] 
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout repository 
      uses: actions/checkout@v4

    - name: üöÄ Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # script: |
        #   echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
        #   cd /var/www/html/shop

        #   echo "üì• –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
        #   git fetch origin master
        #   git reset --hard origin/master 

        #   echo "üßπ –û—á–∏—â–∞–µ–º node_modules –∏ –∫—ç—à..."
        #   rm -rf node_modules
        #   rm -rf .next
        #   npm cache clean --force

        #   echo "üì¶ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        #   npm install

        #   echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
        #   npx next build

        #   echo "‚ö° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PM2..."
        #   pm2 delete next-app 2>/dev/null || true
        #   pm2 start npm --name "next-app" -- start
        #   pm2 save 2>/dev/null

        #   echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
        #   pm2 status
        script: |
          echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
          cd /var/www/html/shop

          # –†–∞–∑—Ä–µ—à–∞–µ–º git —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          git config --global --add safe.directory /var/www/html/shop

          echo "üì• –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
          git fetch origin master
          git reset --hard origin/master

          echo "üßπ –ü–û–õ–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–±–æ—Ä–æ–∫ –∏ –∫–µ—à–∞..."
          rm -rf node_modules .next package-lock.json
          rm -rf .next/cache          # –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Next.js
          npm cache clean --force

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (root –≤–ª–∞–¥–µ–µ—Ç –≤—Å–µ–º)
          chown -R root:root /var/www/html/shop

          echo "üì¶ –ß–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm install --legacy-peer-deps

          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
          npx next build

          echo "‚ö° –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
          pm2 delete next-app 2>/dev/null || true
          pm2 flush                   # –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ PM2
          pm2 start npm --name "next-app" -- start --cwd /var/www/html/shop
          pm2 save

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          pm2 status