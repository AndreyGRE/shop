name: ðŸš€ Deploy Next.js via SSH

on:
  push:
    branches: [ master, main ] 
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ§¾ Checkout repository 
      uses: actions/checkout@v4

    - name: ðŸš€ Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        YOOKASSA_SHOP_ID: ${{ secrets.YOOKASSA_SHOP_ID }}
        YOOKASSA_SECRET_KEY: ${{ secrets.YOOKASSA_SECRET_KEY }}
        YOOKASSA_SECRET_KEY_TEST: ${{ secrets.YOOKASSA_SECRET_KEY_TEST }}
        
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
          cd /var/www/html/shop

          # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ git Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð² ÑÑ‚Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          git config --global --add safe.directory /var/www/html/shop

          echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´..."
          git fetch origin master
          git reset --hard origin/master

          echo "ðŸ§¹ ÐŸÐžÐ›ÐÐÐ¯ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº Ð¸ ÐºÐµÑˆÐ°..."
          rm -rf node_modules .next package-lock.json
          rm -rf .next/cache          # Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Next.js
          npm cache clean --force

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° (root Ð²Ð»Ð°Ð´ÐµÐµÑ‚ Ð²ÑÐµÐ¼)
          chown -R root:root /var/www/html/shop

          echo "ðŸ“¦ Ð§Ð¸ÑÑ‚Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          npm install --legacy-peer-deps

          echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
          npx next build 
         
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ PM2 Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼
          pm2 delete next-app 2>/dev/null || true
          pm2 start npm --name "next-app" -- start
          pm2 save


          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          pm2 status