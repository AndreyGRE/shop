name: üöÄ Deploy Next.js via SSH

on:
  push:
    branches: [ master ] # –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–µ—Ç–∫—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout repository
      uses: actions/checkout@v4

    - name: üöÄ Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
          cd /var/www/html/shop

          echo "üì• –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
          git fetch origin master
          git reset --hard origin/master

          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm install

          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
          npm run build

          echo "‚ö° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PM2..."
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ npm start
          pkill -f "npm start" || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
          pm2 delete next-app || true
          pm2 start npm --name "next-app" -- start
          pm2 save
          pm2 startup

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          pm2 status
